{% extends "base.html" %}

{% block title %}Create Community Post{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0"><i class="fas fa-edit me-2"></i>New Post</h3>
                    <a class="btn btn-outline-secondary" href="{{ url_for('community.index') }}"><i class="fas fa-arrow-left me-1"></i>Back</a>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {{ form.hidden_tag() }}
                        <input type="hidden" name="post_type" id="post_type" value="">
                        <!-- Hidden category drives backend; UI controlled by Post Type buttons -->
                        <input type="hidden" name="category" id="hidden_category" value="{{ form.category.data or 'discussion' }}">

                        <div class="mb-3">
                            <label class="form-label fw-bold">Post Type</label>
                            <div class="d-flex gap-2 flex-wrap">
                                <button type="button" class="btn btn-outline-primary" data-post-type="discussion"><i class="fas fa-comments me-1"></i>Discussion</button>
                                <button type="button" class="btn btn-outline-primary" data-post-type="question"><i class="fas fa-question-circle me-1"></i>Question</button>
                                <button type="button" class="btn btn-outline-primary" data-post-type="announcement"><i class="fas fa-bullhorn me-1"></i>Announcement</button>
                                <button type="button" class="btn btn-outline-primary" data-post-type="news"><i class="fas fa-newspaper me-1"></i>News</button>
                                <button type="button" class="btn btn-outline-secondary" data-post-type="quick"><i class="fas fa-bolt me-1"></i>Quick Update (content only)</button>
                            </div>
                            <div class="form-text">Choose a type to auto-set category and adjust fields.</div>
                        </div>

                        <div class="mb-3" id="title-group">
                            {{ form.title.label(class="form-label fw-bold") }}
                            {{ form.title(class="form-control form-control-lg", placeholder="Optional title (auto from content if left empty)") }}
                            {% if form.title.errors %}
                                <div class="text-danger small mt-1">{% for e in form.title.errors %}<div>{{ e }}</div>{% endfor %}</div>
                            {% endif %}
                        </div>

                        <!-- Removed visible category select; tags remains -->
                        <div class="row" id="meta-row">
                            <div class="col-md-12 mb-3">
                                {{ form.tags.label(class="form-label fw-bold") }}
                                {{ form.tags(class="form-control", placeholder="e.g., mining, agriculture") }}
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form.content.label(class="form-label fw-bold") }}
                            {{ form.content(class="form-control", rows="3", placeholder="Share details with the community...") }}
                            {% if form.content.errors %}
                                <div class="text-danger small mt-1">{% for e in form.content.errors %}<div>{{ e }}</div>{% endfor %}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3" id="image-group">
                            {{ form.image.label(class="form-label fw-bold") }}
                            {{ form.image(class="form-control", accept="image/*") }}
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            <a class="btn btn-outline-secondary" href="{{ url_for('community.index') }}">Cancel</a>
                            <button class="btn btn-primary" type="submit"><i class="fas fa-paper-plane me-1"></i>Publish</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const typeButtons = document.querySelectorAll('[data-post-type]');
    const titleInput = document.getElementById('{{ form.title.id }}');
    const titleGroup = document.getElementById('title-group');
    const metaRow = document.getElementById('meta-row');
    const imageGroup = document.getElementById('image-group');
    const contentInput = document.getElementById('{{ form.content.id }}');
    const postTypeInput = document.getElementById('post_type');
    const hiddenCategory = document.getElementById('hidden_category');

    const typeToCategory = {
        discussion: 'discussion',
        question: 'question',
        announcement: 'announcement',
        news: 'news',
        quick: 'discussion' // fallback category for content-only quick updates
    };

    typeButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            typeButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            const type = this.getAttribute('data-post-type');
            if (postTypeInput) postTypeInput.value = type;
            if (hiddenCategory && typeToCategory[type]) hiddenCategory.value = typeToCategory[type];
            if (type === 'quick') {
                // Content-only mode
                if (titleGroup) titleGroup.style.display = 'none';
                if (imageGroup) imageGroup.style.display = 'none';
            } else {
                // Restore other fields
                if (titleGroup) titleGroup.style.display = '';
                if (imageGroup) imageGroup.style.display = '';
            }
            if (contentInput) contentInput.focus();
        });
    });

    // Auto-resize content textarea
    function autoResize(el) {
        el.style.height = 'auto';
        el.style.overflowY = 'hidden';
        el.style.height = el.scrollHeight + 'px';
    }
    if (contentInput) {
        autoResize(contentInput);
        contentInput.addEventListener('input', function() { autoResize(contentInput); });
    }
});
</script>
{% endblock %}


