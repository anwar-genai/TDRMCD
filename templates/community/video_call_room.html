{% extends "base.html" %}

{% block title %}Video Call - {{ video_call.title }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-video me-2"></i>{{ video_call.title }}</h5>
                    <a class="btn btn-outline-secondary" href="{{ url_for('community.video_calls') }}"><i class="fas fa-arrow-left me-1"></i>Back</a>
                </div>
                <div class="card-body p-0">
                    <!-- Custom Control Panel -->
                    <div class="bg-dark text-white p-3 d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <h6 class="mb-0"><i class="fas fa-video me-2"></i>{{ video_call.title }}</h6>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-light" onclick="toggleAudio()" title="Toggle Microphone">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-light" onclick="toggleVideo()" title="Toggle Camera">
                                    <i class="fas fa-video"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-light" onclick="toggleScreenShare()" title="Share Screen">
                                    <i class="fas fa-desktop"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-light" onclick="toggleChat()" title="Toggle Chat">
                                    <i class="fas fa-comments"></i>
                                </button>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <!-- Virtual Background using Jitsi's built-in dialog -->
                            <button class="btn btn-sm btn-outline-light" type="button" onclick="toggleVirtualBackground()" title="Virtual Background">
                                <i class="fas fa-magic"></i> Background
                            </button>
                            <button class="btn btn-sm btn-outline-light" onclick="toggleParticipants()" title="Participants">
                                <i class="fas fa-users"></i>
                            </button>
                        </div>
                    </div>
                    <!-- Jitsi Container -->
                    <div id="jitsi-container" style="height: 500px; width: 100%;"></div>
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <div class="text-muted small">Room ID: {{ video_call.room_id }}</div>
                    <div class="d-flex gap-2">
                        <div class="text-muted small">Host: 
                            {% if video_call.host.first_name and video_call.host.last_name %}
                                {{ video_call.host.first_name }} {{ video_call.host.last_name }}
                            {% else %}
                                {{ video_call.host.username }}
                            {% endif %}
                        </div>
                        {% if video_call.host_id == current_user.id %}
                        <button class="btn btn-sm btn-danger" onclick="openEndCallModal()">
                            <i class="fas fa-phone-slash me-1"></i>End Call
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
 </div>
 <!-- End Call Confirmation Modal -->
<div class="modal fade" id="endCallModal" tabindex="-1" aria-labelledby="endCallModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="endCallModalLabel"><i class="fas fa-phone-slash me-2 text-danger"></i>End video call?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to end this video call for everyone?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmEndCallBtn">
                    <i class="fas fa-phone-slash me-1"></i>End Call
                </button>
            </div>
        </div>
    </div>
 </div>
 <!-- Prejoin/Waiting Cancel Button -->
 <button id="prejoinCancelBtn" class="btn btn-outline-light position-fixed" style="top: 90px; right: 24px; z-index: 1080; display: none;">
     <i class="fas fa-times me-1"></i> Cancel
 </button>
{% endblock %}


{% block extra_js %}
<script src="https://meet.jit.si/external_api.js" onerror="handleJitsiLoadError()"></script>
<script>
function handleJitsiLoadError() {
    console.error('Failed to load Jitsi Meet API');
    document.querySelector('#jitsi-container').innerHTML = '<div class="alert alert-danger m-3"><i class="fas fa-exclamation-triangle me-2"></i>Failed to load Jitsi Meet API. Please check your internet connection and refresh the page.</div>';
}
const roomId = "{{ video_call.room_id }}";
const jitsiAppId = "{{ jitsi_app_id|default('') }}";
const isJaaS = jitsiAppId && jitsiAppId !== '' && jitsiAppId !== 'your-jaas-app-id-here';
const domain = isJaaS ? '8x8.vc' : 'meet.jit.si';

// JaaS room names must follow the format: vpaas-magic-cookie-<appId>/<roomName>
// Public Jitsi rooms can use any format
const roomName = isJaaS ? `vpaas-magic-cookie-${jitsiAppId}/${roomId}` : `tdrmcd_${roomId}`;

const options = {
    roomName: roomName,
    parentNode: document.querySelector('#jitsi-container'),
    {% if jwt_token %}
    jwt: "{{ jwt_token }}",
    {% endif %}
    userInfo: {
        displayName: "{% if current_user.is_authenticated %}{% if current_user.first_name and current_user.last_name %}{{ current_user.first_name }} {{ current_user.last_name }}{% else %}{{ current_user.username }}{% endif %}{% else %}Guest{% endif %}",
        email: "{{ current_user.email if current_user.is_authenticated else '' }}"
    },
    // WebRTC and browser compatibility settings
    onload: function() {
        console.log('🎥 Jitsi Meet loaded successfully');
    },
    configOverwrite: {
        // WebRTC and browser compatibility fixes
        disableBrowserCheck: true,  // CRITICAL: Disable browser compatibility check
        enableNoAudioDetection: false,
        enableNoisyMicDetection: false,  // Can interfere with WebRTC
        
        // Basic configuration
        startWithAudioMuted: false,
        startWithVideoMuted: false,
        enableWelcomePage: false,
        enableClosePage: false,
        prejoinPageEnabled: false,
        
        // Moderator features
        disableModeratorIndicator: false,
        enableLobby: false,
        requireDisplayName: false,
        
        // WebRTC-friendly video settings
        resolution: 720,
        constraints: {
            video: {
                height: {
                    ideal: 720,
                    max: 1080,
                    min: 180
                },
                width: {
                    ideal: 1280,
                    max: 1920,
                    min: 320
                },
                frameRate: {
                    ideal: 30,
                    max: 30
                }
            },
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            }
        },
        
        // WebRTC optimization
        enableLayerSuspension: true,
        channelLastN: 10,
        enableSimulcast: true,
        
        // P2P settings (can cause issues, disable for better compatibility)
        p2p: {
            enabled: false  // Disable P2P to avoid WebRTC issues
        },
        
        // Features configuration
        enableInsecureRoomNameWarning: false,
        disableDeepLinking: true,
        doNotStoreRoom: true,
        
        // Disable features that might interfere
        disableReactions: false,
        disablePolls: false,
        enableTalkWhileMuted: false  // Can interfere with audio detection
    },
    interfaceConfigOverwrite: {
        // Browser compatibility settings
        ENFORCE_HTTPS: false,  // Don't enforce HTTPS in development
        DISABLE_FOCUS_INDICATOR: false,
        DISABLE_DOMINANT_SPEAKER_INDICATOR: false,
        
        // Toolbar configuration
        TOOLBAR_BUTTONS: [
            'microphone', 'camera', 'desktop', 'fullscreen',
            'fodeviceselection', 'hangup', 'chat', 'settings',
            'videoquality', 'filmstrip', 'participants-pane',
            'tileview', 'videobackgroundblur'
        ],
        
        SETTINGS_SECTIONS: [
            'devices', 'language', 'profile'
        ],
        
        // Branding
        SHOW_JITSI_WATERMARK: false,
        SHOW_BRAND_WATERMARK: false,
        SHOW_POWERED_BY: false,
        SHOW_WATERMARK_FOR_GUESTS: false,
        
        // Video background
        DISABLE_VIDEO_BACKGROUND: false,
        
        // Mobile and browser compatibility
        MOBILE_APP_PROMO: false,
        OPTIMAL_BROWSERS: ['chrome', 'chromium', 'firefox', 'nwjs', 'electron', 'safari'],
        UNSUPPORTED_BROWSERS: []  // Clear unsupported browsers list
    }
};
let api = null;
let isVirtualBackgroundEnabled = false;

// WebRTC support detection
function checkWebRTCSupport() {
    console.log('🔍 Checking WebRTC support...');
    
    // Check for basic WebRTC APIs
    const hasGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) || 
                           !!(navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia);
    
    const hasRTCPeerConnection = !!(window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection);
    
    const hasRTCSessionDescription = !!(window.RTCSessionDescription || window.webkitRTCSessionDescription || window.mozRTCSessionDescription);
    
    const hasRTCIceCandidate = !!(window.RTCIceCandidate || window.webkitRTCIceCandidate || window.mozRTCIceCandidate);
    
    console.log('WebRTC Support Check:');
    console.log('- getUserMedia:', hasGetUserMedia);
    console.log('- RTCPeerConnection:', hasRTCPeerConnection);
    console.log('- RTCSessionDescription:', hasRTCSessionDescription);
    console.log('- RTCIceCandidate:', hasRTCIceCandidate);
    
    const isSupported = hasGetUserMedia && hasRTCPeerConnection && hasRTCSessionDescription && hasRTCIceCandidate;
    
    if (isSupported) {
        console.log('✅ WebRTC is supported');
    } else {
        console.log('❌ WebRTC is not fully supported');
    }
    
    return isSupported;
}

// Test media permissions
function testMediaPermissions() {
    return new Promise((resolve) => {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: false, audio: true })
                .then(() => {
                    console.log('✅ Media permissions granted');
                    resolve(true);
                })
                .catch((error) => {
                    console.warn('⚠️ Media permissions denied or not available:', error);
                    resolve(false);
                });
        } else {
            console.warn('⚠️ getUserMedia not available');
            resolve(false);
        }
    });
}

function initJitsi() {
    const mode = isJaaS ? 'JaaS' : 'Public';
    console.log(`🎥 Initializing Jitsi Meet (${mode} mode)...`);
    console.log('Room:', roomName);
    console.log('Domain:', domain);
    console.log('App ID:', jitsiAppId);
    console.log('Has JWT:', {% if jwt_token %}true{% else %}false{% endif %});
    {% if jwt_token %}
    console.log('JWT Token (first 50 chars):', "{{ jwt_token[:50] }}...");
    {% endif %}
    
    // Check WebRTC support before initializing
    if (!checkWebRTCSupport()) {
        console.error('WebRTC not supported in this browser');
        document.querySelector('#jitsi-container').innerHTML = '<div class="alert alert-warning m-3"><i class="fas fa-exclamation-triangle me-2"></i>WebRTC is not supported in your browser. Please use a modern browser like Chrome, Firefox, or Safari.</div>';
        return;
    }
    
    console.log('Options:', options);
    console.log('✅ WebRTC support detected, initializing Jitsi...');
    
    try {
        // Force HTTPS for WebRTC compatibility if not already
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            console.warn('⚠️  WebRTC works best over HTTPS. Consider using HTTPS for production.');
        }
        
        api = new JitsiMeetExternalAPI(domain, options);
        
        // Add error handling for Jitsi initialization
        api.addListener('readyToClose', () => {
            console.log('Jitsi is ready to close');
        });
        
        // Handle initialization errors
        api.addListener('participantRoleChanged', (event) => {
            console.log('Participant role changed:', event);
        });
        
    } catch (error) {
        console.error('Failed to initialize Jitsi Meet:', error);
        
        // Provide specific error messages based on error type
        let errorMessage = 'Failed to load video call. ';
        if (error.message && error.message.includes('WebRTC')) {
            errorMessage += 'WebRTC is not supported or blocked in your browser.';
        } else if (error.message && error.message.includes('network')) {
            errorMessage += 'Network connection issue. Please check your internet connection.';
        } else {
            errorMessage += 'Please refresh the page and try again.';
        }
        
        document.querySelector('#jitsi-container').innerHTML = `
            <div class="alert alert-danger m-3">
                <i class="fas fa-exclamation-triangle me-2"></i>${errorMessage}
                <hr>
                <div class="mt-3">
                    <h6>Troubleshooting Steps:</h6>
                    <ul class="small">
                        <li>Ensure you're using Chrome, Firefox, Safari, or Edge</li>
                        <li>Allow camera and microphone permissions</li>
                        <li>Disable browser extensions that might block WebRTC</li>
                        <li>Try refreshing the page</li>
                        <li>Check if your network blocks WebRTC traffic</li>
                    </ul>
                    <button class="btn btn-primary btn-sm" onclick="location.reload()">
                        <i class="fas fa-refresh me-1"></i>Retry
                    </button>
                    <a href="https://test.webrtc.org/" target="_blank" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-external-link-alt me-1"></i>Test WebRTC
                    </a>
                </div>
            </div>
        `;
        return;
    }
    
    // Connection events
    api.addListener('videoConferenceLeft', () => {
        console.log('👋 Left video conference');
        window.location.href = "{{ url_for('community.video_calls') }}";
    });

    api.addListener('videoConferenceJoined', () => {
        console.log('✅ Joined video conference');
        hasJoined = true;
        hidePrejoinCancel();
        
        // Set display name after joining
        api.executeCommand('displayName', '{% if current_user.is_authenticated %}{% if current_user.first_name and current_user.last_name %}{{ current_user.first_name }} {{ current_user.last_name }}{% else %}{{ current_user.username }}{% endif %}{% else %}Guest{% endif %}');
    });
    
    // Ready event - fired when Jitsi is fully loaded
    api.addListener('readyToClose', () => {
        console.log('Jitsi Meet is ready to close');
        window.location.href = "{{ url_for('community.video_calls') }}";
    });

    // Handle participant events
    api.addListener('participantJoined', (participant) => {
        console.log('👤 Participant joined:', participant.displayName);
    });

    api.addListener('participantLeft', (participant) => {
        console.log('👋 Participant left:', participant.displayName);
    });

    // Handle audio/video events
    api.addListener('audioMuteStatusChanged', (data) => {
        console.log('🔇 Audio mute status changed:', data);
    });

    api.addListener('videoMuteStatusChanged', (data) => {
        console.log('📹 Video mute status changed:', data);
    });

    // Show cancel while in prejoin (before join event fires)
    showPrejoinCancel();
}

// Use Jitsi's built-in virtual background feature
function toggleVirtualBackground() {
    try {
        if (api) {
            // Use Jitsi's built-in settings panel for virtual backgrounds
            api.executeCommand('toggleSettings');
        }
    } catch (e) {
        console.warn('Unable to toggle settings panel:', e);
        // Fallback: try to open virtual background dialog directly
        try {
            api.executeCommand('toggleVirtualBackgroundDialog');
        } catch (e2) {
            console.warn('Virtual background dialog not available:', e2);
        }
    }
}

function toggleAudio() {
    try {
        if (api) {
            api.executeCommand('toggleAudio');
        }
    } catch (e) {
        console.warn('Unable to toggle audio:', e);
    }
}

function toggleVideo() {
    try {
        if (api) {
            api.executeCommand('toggleVideo');
        }
    } catch (e) {
        console.warn('Unable to toggle video:', e);
    }
}

function toggleScreenShare() {
    try {
        if (api) {
            api.executeCommand('toggleShareScreen');
        }
    } catch (e) {
        console.warn('Unable to toggle screen share:', e);
    }
}

function toggleChat() {
    try {
        if (api) {
            api.executeCommand('toggleChat');
        }
    } catch (e) {
        console.warn('Unable to toggle chat:', e);
    }
}

function toggleParticipants() {
    try {
        if (api) {
            // Use the correct command for participants pane
            api.executeCommand('toggleParticipantsPane', true);
        }
    } catch (e) {
        console.warn('Unable to toggle participants:', e);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Page loaded, starting video call initialization...');
    
    // Check if Jitsi API is loaded
    if (typeof JitsiMeetExternalAPI === 'undefined') {
        console.error('JitsiMeetExternalAPI is not defined');
        document.querySelector('#jitsi-container').innerHTML = '<div class="alert alert-danger m-3"><i class="fas fa-exclamation-triangle me-2"></i>Video call service is unavailable. Please refresh the page or try again later.</div>';
        return;
    }
    
    // Test WebRTC and media permissions before initializing
    console.log('🔬 Running pre-initialization checks...');
    
    testMediaPermissions().then((hasMediaAccess) => {
        if (!hasMediaAccess) {
            console.warn('⚠️ Media permissions not available, but proceeding with initialization');
        }
        
        // Initialize Jitsi regardless of media permissions (user can grant them later)
        initJitsi();
    });
});

function openEndCallModal() {
    const modalEl = document.getElementById('endCallModal');
    if (!modalEl) return;
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();

    const confirmBtn = document.getElementById('confirmEndCallBtn');
    // Avoid attaching multiple listeners
    confirmBtn.replaceWith(confirmBtn.cloneNode(true));
    const freshConfirmBtn = document.getElementById('confirmEndCallBtn');
    freshConfirmBtn.addEventListener('click', reallyEndVideoCall);
}

function reallyEndVideoCall() {
    const btn = document.getElementById('confirmEndCallBtn');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Ending...';
    
    fetch(`/community/video_call/{{ video_call.room_id }}/end`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('endCallModal'));
            if (modal) modal.hide();
            window.location.href = "{{ url_for('community.video_calls') }}";
        } else {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            console.error('Failed to end call:', data.message);
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
        console.error('Error ending video call:', err);
    });
}


// Prejoin cancel support: show button before joined and hide after join
let hasJoined = false;
function showPrejoinCancel() {
    const btn = document.getElementById('prejoinCancelBtn');
    if (btn && !hasJoined) btn.style.display = 'inline-block';
}
function hidePrejoinCancel() {
    const btn = document.getElementById('prejoinCancelBtn');
    if (btn) btn.style.display = 'none';
}
document.getElementById('prejoinCancelBtn')?.addEventListener('click', () => {
    // Hangup and return
    try { api?.executeCommand('hangup'); } catch (e) {}
    window.location.href = "{{ url_for('community.video_calls') }}";
});
</script>

<style>
/* Enhanced video call room styles */
.card {
    border: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

#jitsi-container {
    border-radius: 0 0 0.375rem 0.375rem;
    overflow: hidden;
}

.bg-dark {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important;
}

.btn-outline-light:hover {
    background-color: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.3);
}

.dropdown-menu {
    border: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-radius: 0.375rem;
}

.dropdown-item:hover {
    background-color: #f8f9fa;
}

.dropdown-item i {
    width: 16px;
    text-align: center;
}

/* Loading animation for buttons */
.btn .fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive design */
@media (max-width: 768px) {
    .d-flex.gap-2 {
        gap: 0.5rem !important;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    #jitsi-container {
        height: 400px !important;
    }
}

/* Custom scrollbar for dropdown */
.dropdown-menu::-webkit-scrollbar {
    width: 6px;
}

.dropdown-menu::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.dropdown-menu::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.dropdown-menu::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
{% endblock %}

