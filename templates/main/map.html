{% extends "base.html" %}

{% block title %}Resource Map - TDRMCD{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Map Controls Sidebar -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Map Controls</h5>
                </div>
                <div class="card-body">
                    <!-- Category Filters -->
                    <h6 class="fw-bold mb-2">Resource Categories</h6>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="show-minerals" checked onchange="toggleCategory('minerals')">
                            <label class="form-check-label" for="show-minerals">
                                <i class="fas fa-gem text-primary me-2"></i>Minerals
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="show-agriculture" checked onchange="toggleCategory('agriculture')">
                            <label class="form-check-label" for="show-agriculture">
                                <i class="fas fa-seedling text-success me-2"></i>Agriculture
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="show-wildlife" checked onchange="toggleCategory('wildlife')">
                            <label class="form-check-label" for="show-wildlife">
                                <i class="fas fa-paw text-info me-2"></i>Wildlife
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="show-cultural" checked onchange="toggleCategory('cultural')">
                            <label class="form-check-label" for="show-cultural">
                                <i class="fas fa-landmark text-warning me-2"></i>Cultural
                            </label>
                        </div>
                    </div>

                    <!-- Map Layers -->
                    <h6 class="fw-bold mb-2">Map Layers</h6>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="mapLayer" id="satellite" onchange="changeMapLayer('satellite')">
                            <label class="form-check-label" for="satellite">Satellite View</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="mapLayer" id="terrain" onchange="changeMapLayer('terrain')">
                            <label class="form-check-label" for="terrain">Terrain View</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="mapLayer" id="street" checked onchange="changeMapLayer('street')">
                            <label class="form-check-label" for="street">Street View</label>
                        </div>
                    </div>

                    <!-- Search Location -->
                    <h6 class="fw-bold mb-2">Search Location</h6>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="location-search" placeholder="Search for a place...">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchLocation()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>

                    <!-- Map Statistics -->
                    <div class="bg-light p-3 rounded">
                        <h6 class="fw-bold mb-2">Map Statistics</h6>
                        <div class="small">
                            <div class="d-flex justify-content-between mb-1">
                                <span>Total Resources:</span>
                                <span class="fw-bold" id="total-resources">{{ map_data|length }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span>Visible:</span>
                                <span class="fw-bold" id="visible-resources">{{ map_data|length }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Selected:</span>
                                <span class="fw-bold" id="selected-resources">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Legend</h6>
                </div>
                <div class="card-body">
                    <div class="legend-item d-flex align-items-center mb-2">
                        <div class="legend-marker bg-primary rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                        <small>Minerals</small>
                    </div>
                    <div class="legend-item d-flex align-items-center mb-2">
                        <div class="legend-marker bg-success rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                        <small>Agriculture</small>
                    </div>
                    <div class="legend-item d-flex align-items-center mb-2">
                        <div class="legend-marker bg-info rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                        <small>Wildlife</small>
                    </div>
                    <div class="legend-item d-flex align-items-center">
                        <div class="legend-marker bg-warning rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                        <small>Cultural Heritage</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Map -->
        <div class="col-lg-9 col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-map me-2"></i>Interactive Resource Map
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="centerMap()">
                            <i class="fas fa-crosshairs me-1"></i>Center
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleFullscreen()">
                            <i class="fas fa-expand me-1"></i>Fullscreen
                        </button>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-sm btn-success" onclick="addResourceToMap()">
                            <i class="fas fa-plus me-1"></i>Add Resource
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="map" class="map-container" style="height: 600px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resource Details Modal -->
<div class="modal fade" id="resourceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resource-modal-title">Resource Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resource-modal-body">
                <!-- Resource details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="view-resource-link" class="btn btn-primary">View Full Details</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.custom-marker {
    background: transparent !important;
    border: none !important;
}

.marker-icon {
    transition: transform 0.2s ease;
}

.marker-icon:hover {
    transform: scale(1.1);
}

.map-popup .btn {
    font-size: 0.8rem;
}

.map-popup h6 {
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

.map-popup p {
    font-size: 0.85rem;
    line-height: 1.3;
}

/* Fullscreen styles */
.map-container:fullscreen {
    width: 100vw !important;
    height: 100vh !important;
    background: white;
    display: flex;
    flex-direction: column;
}

.map-container:fullscreen #map {
    width: 100% !important;
    height: 100% !important;
    flex: 1;
}

/* Hide other elements when in fullscreen */
.map-container:fullscreen .row > .col-md-3 {
    display: none;
}

.map-container:fullscreen .row > .col-md-9 {
    width: 100% !important;
    max-width: 100% !important;
    flex: 0 0 100% !important;
}

/* Alternative fullscreen selectors for different browsers */
.map-container:-webkit-full-screen {
    width: 100vw !important;
    height: 100vh !important;
    background: white;
    display: flex;
    flex-direction: column;
}

.map-container:-webkit-full-screen #map {
    width: 100% !important;
    height: 100% !important;
    flex: 1;
}

.map-container:-moz-full-screen {
    width: 100vw !important;
    height: 100vh !important;
    background: white;
    display: flex;
    flex-direction: column;
}

.map-container:-moz-full-screen #map {
    width: 100% !important;
    height: 100% !important;
    flex: 1;
}

.map-container:-ms-fullscreen {
    width: 100vw !important;
    height: 100vh !important;
    background: white;
    display: flex;
    flex-direction: column;
}

.map-container:-ms-fullscreen #map {
    width: 100% !important;
    height: 100% !important;
    flex: 1;
}

/* Custom fullscreen class for additional control */
.map-container.in-fullscreen {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 9999 !important;
    background: white !important;
    display: flex !important;
    flex-direction: column !important;
}

.map-container.in-fullscreen #map {
    width: 100% !important;
    height: 100% !important;
    flex: 1 !important;
    border-radius: 0 !important;
}

.map-container.in-fullscreen .row > .col-md-3 {
    display: none !important;
}

.map-container.in-fullscreen .row > .col-md-9 {
    width: 100% !important;
    max-width: 100% !important;
    flex: 0 0 100% !important;
    height: 100% !important;
    display: flex !important;
    flex-direction: column !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Map data from server
window.mapData = {{ map_data|tojson }};

let map = null;
let markers = {};
let markerGroups = {
    minerals: L.layerGroup(),
    agriculture: L.layerGroup(),
    wildlife: L.layerGroup(),
    cultural: L.layerGroup()
};

// Initialize map
document.addEventListener('DOMContentLoaded', function() {
    initializeMap();
    loadResourceMarkers();
    
    // Check if we need to focus on a specific resource
    const urlParams = new URLSearchParams(window.location.search);
    const focusId = urlParams.get('focus');
    const focusLat = urlParams.get('lat');
    const focusLng = urlParams.get('lng');
    
    console.log('URL Parameters:', { focusId, focusLat, focusLng });
    console.log('Current URL:', window.location.href);
    
    if (focusId && focusLat && focusLng) {
        console.log('Focus parameters found, will focus on resource in 2 seconds...');
        // Focus on the specific resource
        setTimeout(() => {
            console.log('Attempting to focus on resource now...');
            focusOnSpecificResource(parseInt(focusId), parseFloat(focusLat), parseFloat(focusLng));
        }, 2000); // Increased wait time for markers to load
    } else {
        console.log('No focus parameters found or incomplete parameters');
    }
});

function initializeMap() {
    // Check if map is already initialized
    if (map) {
        console.log('Map already initialized, skipping...');
        return;
    }
    
    console.log('Initializing map...');
    
    // Clear any existing map instance
    const mapContainer = document.getElementById('map');
    if (mapContainer._leaflet_id) {
        console.log('Clearing existing map instance...');
        mapContainer._leaflet_id = null;
    }
    
    // Center on KPK, Pakistan with better zoom level
    map = L.map('map').setView([34.0151, 71.5249], 7);
    
    // Default tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    // Add marker groups to map
    Object.values(markerGroups).forEach(group => {
        map.addLayer(group);
    });
    
    // Map event listeners
    map.on('click', function(e) {
        if (window.addingResource) {
            addResourceMarker(e.latlng);
        }
    });
    
    // Auto-fit map to show all resources if they exist
    if (window.mapData && window.mapData.length > 0) {
        fitMapToResources();
    }
}

function loadResourceMarkers() {
    // Check if markers are already loaded
    if (Object.keys(markers).length > 0) {
        console.log('Markers already loaded, skipping...');
        return;
    }
    
    console.log('Loading resource markers...');
    window.mapData.forEach(resource => {
        const marker = createResourceMarker(resource);
        markerGroups[resource.category].addLayer(marker);
        markers[resource.id] = marker;
    });
    
    updateResourceCount();
    
    // Fit map to show all resources
    fitMapToResources();
    console.log(`Loaded ${Object.keys(markers).length} markers`);
}

function fitMapToResources() {
    if (window.mapData && window.mapData.length > 0) {
        const group = new L.featureGroup();
        window.mapData.forEach(resource => {
            if (resource.latitude && resource.longitude) {
                const marker = L.marker([resource.latitude, resource.longitude]);
                group.addLayer(marker);
            }
        });
        
        if (group.getLayers().length > 0) {
            map.fitBounds(group.getBounds().pad(0.1));
        }
    }
}

function createResourceMarker(resource) {
    const iconColor = getIconColor(resource.category);
    const icon = L.divIcon({
        className: 'custom-marker',
        html: `<div class="marker-icon bg-${iconColor} text-white rounded-circle d-flex align-items-center justify-content-center shadow" style="width: 35px; height: 35px; border: 2px solid white;">
                   <i class="fas fa-${getIconName(resource.category)} fa-sm"></i>
               </div>`,
        iconSize: [35, 35],
        iconAnchor: [17, 17]
    });
    
    const marker = L.marker([resource.latitude, resource.longitude], {icon: icon});
    
    // Helper function to escape HTML content for safe insertion
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Create a more detailed popup with proper escaping
    const safeTitle = (resource.title || 'Untitled Resource').replace(/['"\\]/g, '\\$&');
    const safeDescription = (resource.description || '').replace(/['"\\]/g, '\\$&');
    const safeLocation = (resource.location || '').replace(/['"\\]/g, '\\$&');
    
    const popupContent = `
        <div class="map-popup" style="min-width: 250px;">
            <div class="d-flex align-items-start mb-2">
                <div class="flex-shrink-0 me-2">
                    <i class="fas fa-${getIconName(resource.category)} text-${iconColor} fa-lg"></i>
                </div>
                <div class="flex-grow-1">
                    <h6 class="fw-bold mb-1">${safeTitle}</h6>
                    <span class="badge bg-${iconColor} mb-2">${resource.category ? resource.category.charAt(0).toUpperCase() + resource.category.slice(1) : 'Unknown'}</span>
                </div>
            </div>
            <p class="small mb-2 text-muted">${safeDescription.length > 100 ? safeDescription.substring(0, 100) + '...' : safeDescription}</p>
            ${resource.location ? `<p class="small mb-2"><i class="fas fa-map-marker-alt me-1"></i>${safeLocation}</p>` : ''}
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-primary flex-fill" onclick="showResourceDetails(${resource.id})">
                    <i class="fas fa-eye me-1"></i>View Details
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="centerOnResource(${resource.latitude}, ${resource.longitude})">
                    <i class="fas fa-crosshairs"></i>
                </button>
            </div>
        </div>
    `;
    
    marker.bindPopup(popupContent);
    
    return marker;
}

function getIconColor(category) {
    const colors = {
        'minerals': 'primary',
        'agriculture': 'success',
        'wildlife': 'info',
        'cultural': 'warning'
    };
    return colors[category] || 'secondary';
}

function getIconName(category) {
    const icons = {
        'minerals': 'gem',
        'agriculture': 'seedling',
        'wildlife': 'paw',
        'cultural': 'landmark'
    };
    return icons[category] || 'map-marker-alt';
}

function toggleCategory(category) {
    const checkbox = document.getElementById(`show-${category}`);
    if (checkbox.checked) {
        map.addLayer(markerGroups[category]);
    } else {
        map.removeLayer(markerGroups[category]);
    }
    updateResourceCount();
}

function updateResourceCount() {
    let visible = 0;
    Object.keys(markerGroups).forEach(category => {
        if (map.hasLayer(markerGroups[category])) {
            visible += markerGroups[category].getLayers().length;
        }
    });
    
    document.getElementById('visible-resources').textContent = visible;
}

function changeMapLayer(layerType) {
    // Remove current tile layer
    map.eachLayer(function(layer) {
        if (layer instanceof L.TileLayer) {
            map.removeLayer(layer);
        }
    });
    
    // Add new tile layer
    let tileUrl = '';
    switch(layerType) {
        case 'satellite':
            tileUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
            break;
        case 'terrain':
            tileUrl = 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png';
            break;
        default:
            tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    }
    
    L.tileLayer(tileUrl, {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
}

function searchLocation() {
    const query = document.getElementById('location-search').value.trim();
    if (!query) return;
    
    // Simple geocoding using Nominatim API
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`)
        .then(response => response.json())
        .then(data => {
            if (data.length > 0) {
                const result = data[0];
                const lat = parseFloat(result.lat);
                const lng = parseFloat(result.lon);
                
                map.setView([lat, lng], 12);
                
                // Add temporary marker
                const tempMarker = L.marker([lat, lng])
                    .addTo(map)
                    .bindPopup(`<strong>${result.display_name}</strong>`)
                    .openPopup();
                
                // Remove temporary marker after 5 seconds
                setTimeout(() => {
                    map.removeLayer(tempMarker);
                }, 5000);
            } else {
                alert('Location not found. Please try a different search term.');
            }
        })
        .catch(error => {
            console.error('Geocoding error:', error);
            alert('Error searching for location. Please try again.');
        });
}

function centerMap() {
    // Center on KPK
    map.setView([34.0151, 71.5249], 7);
}

function centerOnResource(lat, lng) {
    map.setView([lat, lng], 12);
    // Open the popup for this resource
    const marker = Object.values(markers).find(m => 
        m.getLatLng().lat === lat && m.getLatLng().lng === lng
    );
    if (marker) {
        marker.openPopup();
    }
}

function focusOnSpecificResource(resourceId, lat, lng) {
    console.log(`=== FOCUSING ON RESOURCE ===`);
    console.log(`Resource ID: ${resourceId}, Coordinates: ${lat}, ${lng}`);
    console.log(`Available markers:`, Object.keys(markers));
    console.log(`Map data available:`, window.mapData ? window.mapData.length : 'No data');
    
    // Set the map view to the resource location with higher zoom
    map.setView([lat, lng], 15);
    console.log(`Map view set to coordinates: ${lat}, ${lng} with zoom 15`);
    
    // Try to find the existing marker for this resource
    let targetMarker = null;
    
    // First try to find by resource ID in the markers object
    if (markers[resourceId]) {
        targetMarker = markers[resourceId];
        console.log(`✅ Found marker by resource ID: ${resourceId}`);
    } else {
        console.log(`❌ No marker found for resource ID: ${resourceId}`);
        console.log(`Available marker IDs:`, Object.keys(markers));
        
        // If not found by ID, try to find by coordinates (with tolerance for floating point)
        const tolerance = 0.001; // Increased tolerance for coordinate matching
        for (const [id, marker] of Object.entries(markers)) {
            const markerLat = marker.getLatLng().lat;
            const markerLng = marker.getLatLng().lng;
            console.log(`Checking marker ${id}: ${markerLat}, ${markerLng} vs target: ${lat}, ${lng}`);
            if (Math.abs(markerLat - lat) < tolerance && Math.abs(markerLng - lng) < tolerance) {
                targetMarker = marker;
                console.log(`✅ Found marker by coordinates for ID: ${id}`);
                break;
            }
        }
    }
    
    if (targetMarker) {
        // Open the popup for the found marker
        targetMarker.openPopup();
        console.log('✅ Opened popup for existing marker');
    } else {
        console.log('⚠️ No existing marker found, creating new marker');
        
        // Always create a simple marker for the focus location
        const focusMarker = L.marker([lat, lng]).addTo(map);
        
        // Try to find resource data for better popup
        const resource = window.mapData ? window.mapData.find(r => r.id === resourceId) : null;
        
        if (resource) {
            console.log(`Found resource data:`, resource);
            const popupContent = `
                <div style="min-width: 200px;">
                    <h6><strong>${resource.title}</strong></h6>
                    <p><span class="badge bg-primary">${resource.category}</span></p>
                    <p><i class="fas fa-map-marker-alt"></i> ${resource.location || 'Location not specified'}</p>
                    <p class="text-muted small">${resource.description ? resource.description.substring(0, 80) + '...' : 'No description'}</p>
                </div>
            `;
            focusMarker.bindPopup(popupContent);
        } else {
            console.log(`No resource data found for ID: ${resourceId}`);
            focusMarker.bindPopup(`
                <div>
                    <strong>Resource Location</strong><br>
                    Resource ID: ${resourceId}<br>
                    Coordinates: ${lat}, ${lng}
                </div>
            `);
        }
        
        focusMarker.openPopup();
        console.log('✅ Created and opened new focus marker');
    }
    
    console.log(`=== FOCUS COMPLETE ===`);
}

function toggleFullscreen() {
    const mapContainer = document.querySelector('.map-container');
    
    if (!document.fullscreenElement) {
        // Enter fullscreen
        if (mapContainer.requestFullscreen) {
            mapContainer.requestFullscreen();
        } else if (mapContainer.webkitRequestFullscreen) {
            mapContainer.webkitRequestFullscreen();
        } else if (mapContainer.mozRequestFullScreen) {
            mapContainer.mozRequestFullScreen();
        } else if (mapContainer.msRequestFullscreen) {
            mapContainer.msRequestFullscreen();
        }
        
        // Add fullscreen class for styling
        mapContainer.classList.add('in-fullscreen');
        
        // Invalidate map size after entering fullscreen
        setTimeout(() => {
            if (map) {
                map.invalidateSize();
            }
        }, 200);
    } else {
        // Exit fullscreen
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
        
        // Remove fullscreen class
        mapContainer.classList.remove('in-fullscreen');
        
        // Invalidate map size after exiting fullscreen
        setTimeout(() => {
            if (map) {
                map.invalidateSize();
            }
        }, 200);
    }
}

function showResourceDetails(resourceId) {
    // Find resource data
    const resource = window.mapData.find(r => r.id === resourceId);
    if (!resource) return;
    
    // Update modal content using safe methods
    document.getElementById('resource-modal-title').textContent = resource.title || 'Resource Details';
    
    // Create modal content using DOM methods to avoid string interpolation issues
    const modalBody = document.getElementById('resource-modal-body');
    modalBody.innerHTML = ''; // Clear existing content
    
    const rowDiv = document.createElement('div');
    rowDiv.className = 'row';
    
    const colDiv = document.createElement('div');
    colDiv.className = 'col-md-6';
    
    // Description
    const descH6 = document.createElement('h6');
    descH6.className = 'fw-bold';
    descH6.textContent = 'Description';
    
    const descP = document.createElement('p');
    descP.textContent = resource.description || 'No description available';
    
    // Category
    const catH6 = document.createElement('h6');
    catH6.className = 'fw-bold';
    catH6.textContent = 'Category';
    
    const catSpan = document.createElement('span');
    catSpan.className = `badge bg-${getIconColor(resource.category)} mb-2`;
    catSpan.textContent = resource.category ? resource.category.charAt(0).toUpperCase() + resource.category.slice(1) : 'Unknown';
    
    colDiv.appendChild(descH6);
    colDiv.appendChild(descP);
    colDiv.appendChild(catH6);
    colDiv.appendChild(catSpan);
    
    // Location if available
    if (resource.location) {
        const locH6 = document.createElement('h6');
        locH6.className = 'fw-bold';
        locH6.textContent = 'Location';
        
        const locP = document.createElement('p');
        locP.innerHTML = `<i class="fas fa-map-marker-alt me-2"></i>`;
        locP.appendChild(document.createTextNode(resource.location));
        
        colDiv.appendChild(locH6);
        colDiv.appendChild(locP);
    }
    
    // Add coordinates section
    const coordColDiv = document.createElement('div');
    coordColDiv.className = 'col-md-6';
    
    const coordH6 = document.createElement('h6');
    coordH6.className = 'fw-bold';
    coordH6.textContent = 'Coordinates';
    
    const coordP = document.createElement('p');
    coordP.innerHTML = `<strong>Latitude:</strong> ${resource.latitude}<br><strong>Longitude:</strong> ${resource.longitude}`;
    
    // Add action buttons
    const buttonDiv = document.createElement('div');
    buttonDiv.className = 'd-grid gap-2';
    
    const copyBtn = document.createElement('button');
    copyBtn.className = 'btn btn-sm btn-outline-primary';
    copyBtn.innerHTML = '<i class="fas fa-copy me-2"></i>Copy Coordinates';
    copyBtn.onclick = () => copyCoordinates(resource.latitude, resource.longitude);
    
    const directionsBtn = document.createElement('button');
    directionsBtn.className = 'btn btn-sm btn-outline-info';
    directionsBtn.innerHTML = '<i class="fas fa-directions me-2"></i>Get Directions';
    directionsBtn.onclick = () => getDirections(resource.latitude, resource.longitude);
    
    buttonDiv.appendChild(copyBtn);
    buttonDiv.appendChild(directionsBtn);
    
    coordColDiv.appendChild(coordH6);
    coordColDiv.appendChild(coordP);
    coordColDiv.appendChild(buttonDiv);
    rowDiv.appendChild(coordColDiv);
    modalBody.appendChild(rowDiv);
    
    // Update the view resource link
    document.getElementById('view-resource-link').href = `/resources/${resourceId}`;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('resourceModal'));
    modal.show();
}

function copyCoordinates(lat, lng) {
    const coordinates = `${lat}, ${lng}`;
    navigator.clipboard.writeText(coordinates).then(() => {
        TDRMCD.showToast('Coordinates copied to clipboard!', 'success');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = coordinates;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        TDRMCD.showToast('Coordinates copied to clipboard!', 'success');
    });
}

function getDirections(lat, lng) {
    // Open Google Maps with directions
    const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
    window.open(url, '_blank');
}

let addingResource = false;

function addResourceToMap() {
    if (!addingResource) {
        addingResource = true;
        map.getContainer().style.cursor = 'crosshair';
        TDRMCD.showToast('Click on the map to add a new resource location', 'info');
    } else {
        addingResource = false;
        map.getContainer().style.cursor = '';
    }
}

function addResourceMarker(latlng) {
    if (addingResource) {
        // Redirect to add resource page with coordinates
        const url = `{{ url_for('resources.add') }}?lat=${latlng.lat}&lng=${latlng.lng}`;
        window.location.href = url;
    }
}

// Handle browser fullscreen change events
document.addEventListener('fullscreenchange', handleFullscreenChange);
document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
document.addEventListener('mozfullscreenchange', handleFullscreenChange);
document.addEventListener('MSFullscreenChange', handleFullscreenChange);

function handleFullscreenChange() {
    const mapContainer = document.querySelector('.map-container');
    
    if (!document.fullscreenElement && 
        !document.webkitFullscreenElement && 
        !document.mozFullScreenElement && 
        !document.msFullscreenElement) {
        // Exited fullscreen
        mapContainer.classList.remove('in-fullscreen');
    } else {
        // Entered fullscreen
        mapContainer.classList.add('in-fullscreen');
    }
    
    // Invalidate map size
    setTimeout(() => {
        if (map) {
            map.invalidateSize();
        }
    }, 200);
}
</script>
{% endblock %}
